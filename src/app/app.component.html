<div class="app-container">
  <header class="top-header">
    <div class="header-left">
      <div class="logo-section">
        <div class="logo-icon">
          <div class="pie-chart">
            <div class="divider"></div>
          </div>
        </div>
        <div class="logo-text">
          <h1>Telemis</h1>
          <span class="version">3.0.0</span>
        </div>
      </div>
      
      <nav class="main-nav">
        <a routerLink="/exams" routerLinkActive="active" (click)="setBreadcrumb('Exams')">Exams</a>
        <a routerLink="/worklists" routerLinkActive="active" (click)="setBreadcrumb('Worklists')">Worklists</a>
        <a routerLink="/labels" routerLinkActive="active" (click)="setBreadcrumb('Labels')">Labels</a>
        <a routerLink="/templates" routerLinkActive="active" (click)="setBreadcrumb('Templates')">Templates</a>
      </nav>
    </div>
    
    <div class="header-center">
      <div class="breadcrumb">
        <span>{{currentBreadcrumb}}</span>
      </div>
    </div>
    
    <div class="header-right">
      <div class="header-actions">
        <button class="action-btn" title="Shield">
          <i class="fas fa-shield-alt"></i>
        </button>
        
        <div class="dropdown" [class.open]="isManagementDropdownOpen">
          <button class="action-btn dropdown-toggle" (click)="toggleManagementDropdown()" title="Management">
            <i class="fas fa-lock"></i>
            <span>Management</span>
            <i class="fas fa-chevron-down"></i>
          </button>
          <div class="dropdown-menu">
            <a routerLink="/users" (click)="closeDropdowns(); setBreadcrumb('Users')">
              <i class="fas fa-users"></i>
              Users
            </a>
            <a routerLink="/sites" (click)="closeDropdowns(); setBreadcrumb('Sites')">
              <i class="fas fa-building"></i>
              Sites
            </a>
            <a routerLink="/sectors" (click)="closeDropdowns(); setBreadcrumb('Sectors')">
              <i class="fas fa-stethoscope"></i>
              Sectors
            </a>
            <a routerLink="/patients" (click)="closeDropdowns(); setBreadcrumb('Patients')">
              <i class="fas fa-user-injured"></i>
              Patients
            </a>
            <a routerLink="/conversations" (click)="closeDropdowns(); setBreadcrumb('Conversations')">
              <i class="fas fa-comments"></i>
              Conversations
            </a>
          </div>
        </div>
        
        <button class="action-btn" title="Stamp">
          <i class="fas fa-stamp"></i>
        </button>
        
        <button class="action-btn" title="Settings">
          <i class="fas fa-cog"></i>
        </button>
        
        <div class="dropdown" [class.open]="isMenuDropdownOpen">
          <button class="action-btn dropdown-toggle" (click)="toggleMenuDropdown()" title="Menu">
            <i class="fas fa-bars"></i>
          </button>
          <div class="dropdown-menu">
            <a href="#" (click)="logout()">
              <i class="fas fa-sign-out-alt"></i>
              Logout
            </a>
          </div>
        </div>
      </div>
    </div>
  </header>
  
  <div class="app-body">
    <aside class="left-sidebar">
      <!-- Dashboard -->
      <div class="menu-item" routerLink="/dashboard" routerLinkActive="active" (click)="setBreadcrumb('Dashboard')" style="justify-content: flex-start;">
        <i class="fas fa-chart-bar"></i>
        <span>Dashboard</span>
      </div>
      
      <div class="separator"></div>
      
      <!-- BOXES Section -->
      <div class="section">
        <div class="section-header">
          <span class="section-title">BOXES</span>
        </div>
        <div class="menu-item" (click)="navigateToInbox()">
          <i class="fas fa-inbox"></i>
          <span>Inbox</span>
          <span class="count">{{inboxCount}}</span>
        </div>
        <div class="menu-item" (click)="navigateToPending()">
          <i class="fas fa-pause"></i>
          <span>Pending</span>
          <span class="count">{{pendingCount}}</span>
        </div>
        <div class="menu-item" (click)="navigateToSecondOpinion()">
          <i class="fas fa-users"></i>
          <span>Second Opinion</span>
          <span class="count">{{secondOpinionCount}}</span>
        </div>
        <div class="menu-item" (click)="navigateToCompleted()">
          <i class="fas fa-check-square"></i>
          <span>Completed</span>
          <span class="count">{{completedCount}}</span>
        </div>
      </div>
      
      <div class="separator"></div>
      
      <!-- PRESETS Section -->
      <div class="section">
        <div class="section-header">
          <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="My Presets" [(ngModel)]="presetsFilter" (input)="filterPresets()" (focus)="expandPresets()">
          </div>
          <button class="collapse-btn" (click)="togglePresetsCollapse()">
            <i class="fas" [ngClass]="presetsCollapsed ? 'fa-chevron-down' : 'fa-chevron-up'"></i>
          </button>
        </div>
        <div class="section-content" [ngClass]="{collapsed: presetsCollapsed}">
          <div class="menu-item" *ngFor="let preset of filteredPresets" (click)="selectPreset(preset)">
            <span>{{preset.name}}</span>
            <span class="count">{{preset.count}}</span>
          </div>
        </div>
      </div>
      
      <div class="separator"></div>
      
      <!-- CHAT Section -->
      <div class="section chat-section">
        <div class="section-header">
          <div class="search-bar">
            <i class="fas fa-comment"></i>
            <input type="text" placeholder="Chat" [(ngModel)]="chatFilter" (input)="filterConversations()" (focus)="expandChat()">
          </div>
          <button class="collapse-btn" (click)="toggleChatCollapse()">
            <i class="fas" [ngClass]="chatCollapsed ? 'fa-chevron-down' : 'fa-chevron-up'"></i>
          </button>
        </div>
        <div class="section-content chat-content" [ngClass]="{collapsed: chatCollapsed}">
          <div class="conversation-item" 
               *ngFor="let conv of filteredConversations" 
               [ngClass]="{unread: conv.isUnread, pinned: conv.isPinned}"
               (click)="openConversationModal(conv)">
            <img [src]="conv.avatar" alt="Avatar" class="avatar" onerror="this.src='https://via.placeholder.com/40x40/4ade80/000000?text=U'">
            <div class="conversation-info">
              <div class="first-line">
                <span class="recipient" [ngClass]="{bold: conv.isUnread}">
                  <i class="fas fa-envelope" *ngIf="conv.isUnread"></i>
                  {{conv.recipient}}
                </span>
                <span class="timestamp">
                  <i class="fas fa-thumbtack" *ngIf="conv.isPinned"></i>
                  {{formatTimestamp(conv.lastMessageDate)}}
                </span>
              </div>
              <div class="second-line">
                <span class="exam-info">{{conv.patientName}} - {{formatExamDate(conv.examDate)}} - {{truncateDescription(conv.examDescription)}}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </aside>
    
    <main class="main-content">
      <router-outlet></router-outlet>
    </main>
  </div>
  
  <!-- Conversation Modal -->
  <div class="modal-overlay" *ngIf="selectedConversation" (click)="closeConversationModal()">
    <div class="conversation-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="header-info">
          <img [src]="selectedConversation.avatar" alt="Avatar" class="modal-avatar">
          <div class="header-text">
            <h3>{{selectedConversation.recipient}}</h3>
            <p>{{selectedConversation.patientName}} - {{formatExamDate(selectedConversation.examDate)}}</p>
          </div>
        </div>
        <div class="header-actions">
          <div class="dropdown" [class.open]="isConversationMenuOpen">
            <button class="menu-btn" (click)="toggleConversationMenu()">
              <i class="fas fa-ellipsis-v"></i>
            </button>
            <div class="dropdown-menu">
              <a href="#" (click)="markAsUnread(selectedConversation); $event.preventDefault()">
                <i class="fas fa-envelope"></i>
                Mark as unread
              </a>
              <a href="#" (click)="togglePin(selectedConversation); $event.preventDefault()">
                <i class="fas fa-thumbtack"></i>
                {{selectedConversation.isPinned ? 'Unpin' : 'Pin'}}
              </a>
            </div>
          </div>
          <button class="close-btn" (click)="closeConversationModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <div class="exam-section">
        <p>{{selectedConversation.examDescription}}</p>
        <button class="view-exam-btn">
          <i class="fas fa-eye"></i>
          Open in Viewer
        </button>
      </div>
      
      <div class="messages-section">
        <div class="message" 
             *ngFor="let message of selectedConversation.messages"
             [ngClass]="{own: message.sender === 'Damien'}">
          <div class="message-bubble">
            {{message.content}}
          </div>
          <div class="message-time">{{formatMessageTime(message.timestamp)}}</div>
        </div>
      </div>
      
      <div class="message-input-section">
        <input type="text" 
               placeholder="Type a message..." 
               [(ngModel)]="newMessage"
               (keyup.enter)="sendMessage()"
               class="message-input">
        <button class="send-btn" (click)="sendMessage()" [disabled]="!newMessage.trim()">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>
</div>