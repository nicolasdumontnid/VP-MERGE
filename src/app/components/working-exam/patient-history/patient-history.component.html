<div class="patient-history-container">
  <div class="panel-header">
    <button class="close-btn" (click)="onClose()" title="Close exam">
      <i class="fas fa-times"></i>
    </button>
    <div class="header-content">
      <h3>Patient History</h3>
      <p class="subtitle">A comprehensive overview for radiologists.</p>
    </div>
  </div>
  
  <div class="panel-content">
    <!-- Burger Menu -->
    <div class="menu-section">
      <div class="dropdown" [class.open]="isMenuOpen">
        <button class="burger-menu-btn" (click)="toggleMenu()" title="Add content block">
          <i class="fas fa-bars"></i>
        </button>
        <div class="dropdown-menu">
          <button 
            class="dropdown-item" 
            *ngFor="let option of menuOptions"
            (click)="selectMenuOption(option)">
            <i [class]="option.icon"></i>
            <span>{{option.label}}</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Active Blocks -->
    <div class="blocks-container">
      <div class="content-block" *ngFor="let block of activeBlocks">
        <!-- Block Header -->
        <div class="block-header">
          <div class="block-title-section">
            <h4>{{block.title}}</h4>
            <div class="radio-badges" *ngIf="block.id === 'visual-map'">
              <label class="radio-badge">
                <input type="radio" name="anatomical-view" value="bones" checked>
                <span>bones</span>
              </label>
              <label class="radio-badge">
                <input type="radio" name="anatomical-view" value="organs">
                <span>organs</span>
              </label>
            </div>
            <div class="badges" *ngIf="block.badges && block.id !== 'visual-map'">
              <span class="badge" *ngFor="let badge of block.badges">{{badge}}</span>
            </div>
          </div>
          <button class="remove-block-btn" (click)="removeBlock(block.id)" title="Remove block">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <!-- Block Content -->
        <div class="block-content">
          <!-- IA Summary -->
          <div *ngIf="block.content.type === 'summary'" class="summary-content">
            <p>{{block.content.text}}</p>
          </div>

          <!-- Current Exam -->
          <div *ngIf="block.content.type === 'current-exam'" class="current-exam-content">
            <h4 class="current-exam-title">CURRENT EXAM</h4>
            <div class="exam-details-list">
              <div class="exam-detail-item" *ngIf="exam">
                <span class="detail-key">Reference</span>
                <span class="detail-value">{{exam.reference}}</span>
              </div>
              <div class="exam-detail-item" *ngIf="exam">
                <span class="detail-key">Date</span>
                <span class="detail-value">{{exam.examDate | date:'dd/MM/yyyy HH:mm'}}</span>
              </div>
              <div class="exam-detail-item" *ngIf="exam">
                <span class="detail-key">Type</span>
                <span class="detail-value">{{exam.title}}</span>
              </div>
              <div class="exam-detail-item" *ngIf="exam">
                <span class="detail-key">Description</span>
                <span class="detail-value">{{exam.description}}</span>
              </div>
            </div>
          </div>

          <!-- Last Report Conclusion -->
          <div *ngIf="block.content.type === 'conclusion'" class="conclusion-content">
            <p>{{block.content.text}}</p>
          </div>

          <!-- Patient Records -->
          <div *ngIf="block.content.type === 'records'" class="records-content">
            <div class="record-item" *ngFor="let record of block.content.records">
              <div class="record-header">
                <span class="record-date">{{record.date}}</span>
                <span class="record-name">{{record.name}}</span>
              </div>
              <p class="record-description">{{record.description}}</p>
            </div>
            <div class="block-footer">
              <button class="see-all-btn">see all →</button>
            </div>
          </div>

          <!-- Visual Patient Map -->
          <div *ngIf="block.content.type === 'anatomical'" class="anatomical-content">
            <div class="anatomical-view">
              <img src="assets/skeleton+skin.svg" 
                   alt="Human Body Anatomy" 
                   class="human-body-svg"
                   (click)="onBodyClick($event)">
            </div>
          </div>

          <!-- All Images -->
          <div *ngIf="block.content.type === 'images'" class="images-content">
            <div class="date-group" *ngFor="let date of getImageDates()">
              <h5 class="date-header">{{formatDate(date)}}</h5>
              <div class="images-row">
                <div class="image-thumbnail" *ngFor="let image of block.content.imagesByDate[date]">
                  <img [src]="image" [alt]="'Medical image from ' + date" 
                       onerror="this.src='https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=120&h=120&fit=crop&auto=format&sat=-100'">
                </div>
              </div>
            </div>
            <div class="block-footer">
              <button class="see-all-btn">see all →</button>
            </div>
          </div>

          <!-- Patient Information -->
          <div *ngIf="block.content.type === 'patient-info'" class="patient-info-content">
            <div class="info-section" *ngIf="exam">
              <h4>Patient Information</h4>
              <div class="info-item">
                <label>Name:</label>
                <span>{{exam.patientName}}</span>
              </div>
              <div class="info-item">
                <label>Date of Birth:</label>
                <span>{{exam.patientBirthDate | date:'dd/MM/yyyy'}}</span>
              </div>
              <div class="info-item">
                <label>Gender:</label>
                <span>{{exam.patientGender}}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>