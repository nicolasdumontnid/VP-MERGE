<div class="patient-history-container">
  <div class="panel-header">
    <button class="close-btn" (click)="onClose()" title="Close exam">
      <i class="fas fa-times"></i>
    </button>
    <div class="header-content">
      <h3>Patient History</h3>
      <p class="subtitle">A comprehensive overview for radiologists.</p>
    </div>
  </div>
  
  <div class="panel-content">
    <!-- Burger Menu -->
    <div class="menu-section">
      <div class="dropdown" [class.open]="isMenuOpen">
        <button class="burger-menu-btn" (click)="toggleMenu()" title="Add content block">
          <i class="fas fa-bars"></i>
        </button>
        <div class="dropdown-menu">
          <button 
            class="dropdown-item" 
            *ngFor="let option of menuOptions"
            (click)="selectMenuOption(option)">
            <i [class]="option.icon"></i>
            <span>{{option.label}}</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Active Blocks -->
    <div class="blocks-container">
      <div class="content-block" *ngFor="let block of activeBlocks">
        <!-- Block Header -->
        <div class="block-header">
          <div class="block-title-section">
            <h4>{{block.title}}</h4>
            <div class="badges" *ngIf="block.badges">
              <span class="badge" *ngFor="let badge of block.badges">{{badge}}</span>
            </div>
          </div>
          <button class="remove-block-btn" (click)="removeBlock(block.id)" title="Remove block">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <!-- Block Content -->
        <div class="block-content">
          <!-- IA Summary -->
          <div *ngIf="block.content.type === 'summary'" class="summary-content">
            <p>{{block.content.text}}</p>
          </div>

          <!-- Current Exam -->
          <div *ngIf="block.content.type === 'current-exam'" class="current-exam-content">
            <h4 class="current-exam-title">CURRENT EXAM</h4>
            <div class="exam-details-list">
              <div class="exam-detail-item" *ngIf="exam">
                <span class="detail-key">Reference</span>
                <span class="detail-value">{{exam.reference}}</span>
              </div>
              <div class="exam-detail-item" *ngIf="exam">
                <span class="detail-key">Date</span>
                <span class="detail-value">{{exam.examDate | date:'dd/MM/yyyy HH:mm'}}</span>
              </div>
              <div class="exam-detail-item" *ngIf="exam">
                <span class="detail-key">Type</span>
                <span class="detail-value">{{exam.title}}</span>
              </div>
              <div class="exam-detail-item" *ngIf="exam">
                <span class="detail-key">Description</span>
                <span class="detail-value">{{exam.description}}</span>
              </div>
            </div>
          </div>

          <!-- Last Report Conclusion -->
          <div *ngIf="block.content.type === 'conclusion'" class="conclusion-content">
            <p>{{block.content.text}}</p>
          </div>

          <!-- Patient Records -->
          <div *ngIf="block.content.type === 'records'" class="records-content">
            <div class="record-item" *ngFor="let record of block.content.records">
              <div class="record-header">
                <span class="record-date">{{record.date}}</span>
                <span class="record-name">{{record.name}}</span>
              </div>
              <p class="record-description">{{record.description}}</p>
            </div>
            <div class="block-footer">
              <button class="see-all-btn">see all →</button>
            </div>
          </div>

          <!-- Visual Patient Map -->
          <div *ngIf="block.content.type === 'anatomical'" class="anatomical-content">
            <div class="anatomical-view">
              <svg viewBox="0 0 200 400" class="human-body-svg">
                <!-- Body outline -->
                <path d="M100 20 C85 20 75 30 75 45 L75 60 C70 65 65 70 65 80 L65 120 C60 125 55 130 55 140 L55 200 C55 210 60 220 65 225 L65 280 C65 290 70 300 75 305 L75 350 C75 360 80 370 85 375 L85 390 C85 395 90 400 95 400 L105 400 C110 400 115 395 115 390 L115 375 C120 370 125 360 125 350 L125 305 C130 300 135 290 135 280 L135 225 C140 220 145 210 145 200 L145 140 C145 130 140 125 135 120 L135 80 C135 70 130 65 125 60 L125 45 C125 30 115 20 100 20 Z" 
                      fill="#4b5563" 
                      stroke="#6b7280" 
                      stroke-width="2"/>
                
                <!-- Head -->
                <circle cx="100" cy="35" r="15" fill="#5b6572" stroke="#6b7280" stroke-width="1"/>
                
                <!-- Brain (clickable) -->
                <circle cx="100" cy="32" r="8" fill="#ef4444" class="organ-svg" title="Brain" (click)="selectOrgan('brain')"/>
                
                <!-- Heart (clickable) -->
                <path d="M95 85 C95 80 90 75 85 75 C80 75 75 80 75 85 C75 80 70 75 65 75 C60 75 55 80 55 85 C55 95 75 110 85 120 C95 110 115 95 115 85 C115 80 110 75 105 75 C100 75 95 80 95 85 Z" 
                      fill="#dc2626" 
                      class="organ-svg" 
                      title="Heart" 
                      (click)="selectOrgan('heart')"
                      transform="translate(15, -10) scale(0.8)"/>
                
                <!-- Lungs (clickable) -->
                <ellipse cx="80" cy="95" rx="12" ry="20" fill="#3b82f6" class="organ-svg" title="Left Lung" (click)="selectOrgan('left-lung')"/>
                <ellipse cx="120" cy="95" rx="12" ry="20" fill="#3b82f6" class="organ-svg" title="Right Lung" (click)="selectOrgan('right-lung')"/>
                
                <!-- Liver (clickable) -->
                <ellipse cx="105" cy="130" rx="25" ry="15" fill="#f59e0b" class="organ-svg" title="Liver" (click)="selectOrgan('liver')"/>
                
                <!-- Kidneys (clickable) -->
                <ellipse cx="85" cy="150" rx="8" ry="12" fill="#10b981" class="organ-svg" title="Left Kidney" (click)="selectOrgan('left-kidney')"/>
                <ellipse cx="115" cy="150" rx="8" ry="12" fill="#10b981" class="organ-svg" title="Right Kidney" (click)="selectOrgan('right-kidney')"/>
                
                <!-- Stomach (clickable) -->
                <ellipse cx="90" cy="120" rx="10" ry="8" fill="#8b5cf6" class="organ-svg" title="Stomach" (click)="selectOrgan('stomach')"/>
                
                <!-- Arms -->
                <ellipse cx="45" cy="100" rx="8" ry="30" fill="#5b6572" stroke="#6b7280" stroke-width="1"/>
                <ellipse cx="155" cy="100" rx="8" ry="30" fill="#5b6572" stroke="#6b7280" stroke-width="1"/>
                
                <!-- Legs -->
                <ellipse cx="85" cy="320" rx="12" ry="60" fill="#5b6572" stroke="#6b7280" stroke-width="1"/>
                <ellipse cx="115" cy="320" rx="12" ry="60" fill="#5b6572" stroke="#6b7280" stroke-width="1"/>
              </svg>
            </div>
          </div>

          <!-- All Images -->
          <div *ngIf="block.content.type === 'images'" class="images-content">
            <div class="date-group" *ngFor="let date of getImageDates()">
              <h5 class="date-header">{{formatDate(date)}}</h5>
              <div class="images-row">
                <div class="image-thumbnail" *ngFor="let image of block.content.imagesByDate[date]">
                  <img [src]="image" [alt]="'Medical image from ' + date" 
                       onerror="this.src='https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=120&h=120&fit=crop&auto=format&sat=-100'">
                </div>
              </div>
            </div>
            <div class="block-footer">
              <button class="see-all-btn">see all →</button>
            </div>
          </div>

          <!-- Patient Information -->
          <div *ngIf="block.content.type === 'patient-info'" class="patient-info-content">
            <div class="info-section" *ngIf="exam">
              <h4>Patient Information</h4>
              <div class="info-item">
                <label>Name:</label>
                <span>{{exam.patientName}}</span>
              </div>
              <div class="info-item">
                <label>Date of Birth:</label>
                <span>{{exam.patientBirthDate | date:'dd/MM/yyyy'}}</span>
              </div>
              <div class="info-item">
                <label>Gender:</label>
                <span>{{exam.patientGender}}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>