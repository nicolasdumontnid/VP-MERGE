<div class="patient-history-container">
  <div class="panel-header">
    <button class="close-btn" (click)="onClose()" title="Close exam">
      <i class="fas fa-times"></i>
    </button>
    <div class="header-content">
      <h3>Patient History</h3>
      <p class="subtitle">A comprehensive overview for radiologists.</p>
    </div>
  </div>
  
  <div class="panel-content">
    <!-- Burger Menu -->
    <div class="menu-section">
      <div class="dropdown" [class.open]="isMenuOpen">
        <button class="burger-menu-btn" (click)="toggleMenu()" title="Add content block">
          <i class="fas fa-bars"></i>
        </button>
        <div class="dropdown-menu">
          <button 
            class="dropdown-item" 
            *ngFor="let option of getAvailableMenuOptions()"
            (click)="selectMenuOption(option)">
            <i [class]="option.icon"></i>
            <span>{{option.label}}</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Active Blocks -->
    <div class="blocks-container">
      <div class="content-block" *ngFor="let block of activeBlocks">
        <!-- Block Header -->
        <div class="block-header">
          <div class="block-title-section" (click)="toggleBlockCollapse(block.id)">
            <h4>{{block.title}}</h4>
            <div class="radio-badges" *ngIf="block.id === 'visual-map'">
              <label class="radio-badge">
                <input type="radio" name="anatomical-view" value="bones" [(ngModel)]="selectedAnatomicalView">
                <span>bones</span>
              </label>
              <label class="radio-badge organs-badge">
                <input type="radio" name="anatomical-view" value="organs" [(ngModel)]="selectedAnatomicalView">
                <span>organs</span>
              </label>
            </div>
            <div class="badges" *ngIf="block.badges && block.id !== 'visual-map' && block.id !== 'calendar-map'">
              <span class="badge" *ngFor="let badge of block.badges">{{badge}}</span>
            </div>
          </div>
          <button class="remove-block-btn" (click)="removeBlock(block.id)" title="Remove block">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <!-- Block Content -->
        <div class="block-content" [class.collapsed]="block.isCollapsed">
          <!-- IA Summary -->
          <div *ngIf="block.content.type === 'summary'" class="summary-content">
            <p>{{block.content.text}}</p>
          </div>

          <!-- Current Exam -->
          <div *ngIf="block.content.type === 'current-exam'" class="current-exam-content">
            <h4 class="current-exam-title">CURRENT EXAM</h4>
            <div class="exam-details-list">
              <div class="exam-detail-item" *ngIf="exam">
                <span class="detail-key">Reference</span>
                <span class="detail-value">{{exam.reference}}</span>
              </div>
              <div class="exam-detail-item" *ngIf="exam">
                <span class="detail-key">Date</span>
                <span class="detail-value">{{exam.examDate | date:'dd/MM/yyyy HH:mm'}}</span>
              </div>
              <div class="exam-detail-item" *ngIf="exam">
                <span class="detail-key">Type</span>
                <span class="detail-value">{{exam.title}}</span>
              </div>
              <div class="exam-detail-item" *ngIf="exam">
                <span class="detail-key">Description</span>
                <span class="detail-value">{{exam.description}}</span>
              </div>
            </div>
          </div>

          <!-- Last Report Conclusion -->
          <div *ngIf="block.content.type === 'conclusion'" class="conclusion-content">
            <p>{{block.content.text}}</p>
          </div>

          <!-- Patient Records -->
          <div *ngIf="block.content.type === 'records'" class="records-content">
            <div class="record-item" *ngFor="let record of block.content.records">
              <div class="record-header">
                <span class="record-date">{{record.date}}</span>
                <span class="record-name">{{record.name}}</span>
              </div>
              <p class="record-description">{{record.description}}</p>
            </div>
            <div class="block-footer">
              <button class="see-all-btn">see all â†’</button>
            </div>
          </div>

          <!-- Visual Patient Map -->
          <div *ngIf="block.content.type === 'anatomical'" class="anatomical-content">
            <div class="anatomical-view">
              <img [src]="selectedAnatomicalView === 'bones' ? 'assets/skeleton+skin.svg' : 'assets/skeleton_and_organs.svg'" 
                   [alt]="selectedAnatomicalView === 'bones' ? 'Human Skeleton' : 'Human Organs'" 
                   class="human-body-svg"
                   (click)="onBodyClick($event)"
                   (wheel)="onSvgWheel($event)"
                   [style.transform]="'scale(' + svgZoomLevel + ')'"
                   [style.transformOrigin]="svgTransformOrigin">
            </div>
          </div>

          <!-- Calendar Map -->
          <div *ngIf="block.content.type === 'calendar-map'" class="calendar-map-content">
            <!-- Graphic Filter Component -->
            <app-graphic-filter 
              [sectors]="sectors"
              (filterChange)="onGraphicFilterChange($event)">
            </app-graphic-filter>
            
            <!-- Open Selection Button -->
            <div class="selection-controls" *ngIf="selectedExams.size > 0">
              <button class="open-selection-btn" (click)="openSelectionModal()">
                <i class="fas fa-folder-open"></i>
                Open selection ({{selectedExams.size}})
              </button>
            </div>
            
            <div class="chart-container">
              <!-- Chart Header (empty space above Y-axis) -->
              <div class="chart-header"></div>
              
              <!-- Y-axis (fixed, always visible) -->
              <div class="chart-y-axis" *ngIf="graphicFilterState.viewMode === 'department'">
                <div class="y-axis-item" *ngFor="let sector of getVisibleSectors()">
                  {{sector}}
                </div>
              </div>
              
              <!-- SVG Body Reference (for anatomy view) -->
              <div class="body-reference" *ngIf="graphicFilterState.viewMode === 'anatomy'">
                <img src="assets/skeleton+skin.svg" 
                     alt="Human Skeleton Reference" 
                     class="reference-svg">
              </div>
              
              <!-- Y-axis for anatomy (overlaid on SVG) -->
              <div class="chart-y-axis" *ngIf="graphicFilterState.viewMode === 'anatomy'" style="background: transparent; border: none;">
                <div class="y-axis-item" *ngFor="let region of getVisibleAnatomicalRegions()" style="background: rgba(42, 42, 42, 0.8); margin: 2px; border-radius: 4px;">
                  {{region}}
                </div>
              </div>
              
              <!-- Scrollable chart body -->
              <div class="chart-body">
                <div class="chart-content" [style.width.px]="getChartWidth()">
                  <!-- Horizontal grid lines -->
                  <div class="grid-line-horizontal" 
                       *ngFor="let index of getYAxisIndices()"
                       [style.top.%]="(index / getYAxisCount()) * 100">
                  </div>
                  
                  <!-- Vertical grid lines (years) -->
                  <div class="grid-line-vertical" 
                       *ngFor="let year of getVisibleYears()"
                       [class.today]="isToday(year)"
                       [style.left.px]="getYearPosition(year)">
                  </div>
                  
                  <!-- Exam points -->
                  <div class="exam-points">
                    <div class="exam-point" 
                         *ngFor="let exam of getFilteredExams()"
                         [style.background-color]="selectedExams.has(exam.id) ? '#ef4444' : getPointColor(exam)"
                         [style.border-color]="selectedExams.has(exam.id) ? '#dc2626' : getPointBorderColor(exam)"
                         [style.left.px]="getExamPositionX(exam)"
                         [style.top.%]="getExamPositionY(exam)"
                         (mouseenter)="onExamPointEnter($event, exam)"
                         (mouseleave)="onExamPointLeave()"
                         (click)="onExamPointClick($event, exam)"
                         (contextmenu)="onExamPointRightClick($event, exam)">
                      
                      <!-- Exam Label -->
                      <div class="exam-label" 
                           [style.left.px]="0"
                           [style.top.px]="-45">
                        <div class="exam-title">{{exam.title}}</div>
                        <div class="exam-date">{{exam.date | date:'yyyy-MM-dd'}}</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Tooltip -->
                  <div class="exam-tooltip-detailed"
                       [hidden]="!hoveredExam"
                       [style.left.px]="tooltipPosition.x"
                       [style.top.px]="tooltipPosition.y"
                       (mouseenter)="onTooltipEnter()"
                       (mouseleave)="onTooltipLeave()">
                    <div class="tooltip-header-detailed">
                      <strong>{{hoveredExam?.title}}</strong>
                      <span class="tooltip-date">{{hoveredExam?.date | date:'dd/MM/yyyy'}}</span>
                    </div>
                    <div class="tooltip-content-detailed">
                      <div class="tooltip-section">
                        <div class="tooltip-row">
                          <span class="tooltip-label">{{graphicFilterState.viewMode === 'anatomy' ? 'RÃ©gion:' : 'DÃ©partement:'}}</span>
                          <span class="tooltip-value">{{graphicFilterState.viewMode === 'anatomy' ? hoveredExam?.region : hoveredExam?.sector}}</span>
                        </div>
                        <div class="tooltip-row">
                          <span class="tooltip-label">Site:</span>
                          <span class="tooltip-value">{{hoveredExam?.site}}</span>
                        </div>
                      </div>
                      
                      <!-- Images Section -->
                      <div class="tooltip-images" *ngIf="hoveredExam?.images && hoveredExam.images.length > 0">
                        <div class="tooltip-section-title">Images</div>
                        <div class="tooltip-thumbnails">
                          <div class="tooltip-thumbnail" *ngFor="let image of hoveredExam.images.slice(0, 4)">
                            <img [src]="image.thumbnail" [alt]="image.name" 
                                 onerror="this.src='assets/images/radio/0-thumbnail.jpeg'">
                          </div>
                          <div class="tooltip-more" *ngIf="hoveredExam.images.length > 4">
                            +{{hoveredExam.images.length - 4}}
                          </div>
                        </div>
                      </div>
                      
                      <!-- Documents Section -->
                      <div class="tooltip-documents" *ngIf="hoveredExam?.documents && hoveredExam.documents.length > 0">
                        <div class="tooltip-section-title">Documents</div>
                        <div class="tooltip-doc-icons">
                          <div class="tooltip-doc-icon" *ngFor="let doc of hoveredExam.documents.slice(0, 3)" [title]="doc.name">
                            <i class="fas fa-file-pdf" *ngIf="doc.type === 'pdf'"></i>
                            <i class="fas fa-file-excel" *ngIf="doc.type === 'excel'"></i>
                            <i class="fas fa-file-alt" *ngIf="doc.type === 'text'"></i>
                            <i class="fas fa-play-circle" *ngIf="doc.type === 'video'"></i>
                          </div>
                          <div class="tooltip-more" *ngIf="hoveredExam.documents.length > 3">
                            +{{hoveredExam.documents.length - 3}}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- X-axis (fixed, always visible) -->
              <div class="chart-x-axis">
                <div class="x-axis-content" [style.width.px]="getChartWidth()">
                  <div class="x-axis-label" 
                       *ngFor="let year of getVisibleYears()"
                       [class.today]="isToday(year)"
                       [style.left.px]="getYearPosition(year)">
                    {{isToday(year) ? 'Today' : year}}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- All Images -->
          <div *ngIf="block.content.type === 'images'" class="images-content">
            <div class="date-group" *ngFor="let date of getImageDates()">
              <h5 class="date-header">{{formatDate(date)}}</h5>
              <div class="images-row">
                <div class="image-thumbnail" *ngFor="let image of block.content.imagesByDate[date]">
                  <img [src]="image" [alt]="'Medical image from ' + date" 
                       onerror="this.src='assets/images/radio/0-thumbnail.jpeg'">
                </div>
              </div>
            </div>
            <div class="block-footer">
              <button class="see-all-btn">see all â†’</button>
            </div>
          </div>

          <!-- Patient Information -->
          <div *ngIf="block.content.type === 'patient-info'" class="patient-info-content">
            <div class="info-section" *ngIf="exam">
              <h4>Patient Information</h4>
              <div class="info-item">
                <label>Name:</label>
                <span>{{exam.patientName}}</span>
              </div>
              <div class="info-item">
                <label>Date of Birth:</label>
                <span>{{exam.patientBirthDate | date:'dd/MM/yyyy'}}</span>
              </div>
              <div class="info-item">
                <label>Gender:</label>
                <span>{{exam.patientGender}}</span>
              </div>
            </div>
          </div>

          <!-- External Sources -->
          <div *ngIf="block.content.type === 'external-sources'" class="external-sources-content">
            <div class="external-source-selector">
              <select [(ngModel)]="selectedExternalSource" (change)="onExternalSourceChange()" class="source-select">
                <option value="SEGUR">SEGUR</option>
                <option value="E-HEALTH">E-HEALTH</option>
              </select>
            </div>
            
            <div class="external-content" *ngIf="showExternalContent">
              <p class="no-content-message">No external data available from {{selectedExternalSource}} for this patient.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>