<div class="patient-history-container">
  <div class="panel-header">
    <button class="close-btn" (click)="onClose()" title="Close exam">
      <i class="fas fa-times"></i>
    </button>
    <div class="header-content">
      <h3>Patient History</h3>
      <p class="subtitle">A comprehensive overview for radiologists.</p>
    </div>
  </div>
  
  <div class="panel-content">
    <!-- Burger Menu -->
    <div class="menu-section">
      <div class="dropdown" [class.open]="isMenuOpen">
        <button class="burger-menu-btn" (click)="toggleMenu()" title="Add content block">
          <i class="fas fa-bars"></i>
        </button>
        <div class="dropdown-menu">
          <button 
            class="dropdown-item" 
            *ngFor="let option of getAvailableMenuOptions()"
            (click)="selectMenuOption(option)">
            <i [class]="option.icon"></i>
            <span>{{option.label}}</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Active Blocks -->
    <div class="blocks-container">
      <div class="content-block" *ngFor="let block of activeBlocks">
        <!-- Block Header -->
        <div class="block-header">
          <div class="block-title-section" (click)="toggleBlockCollapse(block.id)">
            <h4>{{block.title}}</h4>
            <div class="radio-badges" *ngIf="block.id === 'visual-map'">
              <label class="radio-badge">
                <input type="radio" name="anatomical-view" value="bones" [(ngModel)]="selectedAnatomicalView">
                <span>bones</span>
              </label>
              <label class="radio-badge organs-badge">
                <input type="radio" name="anatomical-view" value="organs" [(ngModel)]="selectedAnatomicalView">
                <span>organs</span>
              </label>
            </div>
            <div class="badges" *ngIf="block.badges && block.id === 'calendar-map'">
              <span [class]="getBadgeClass(badge)" 
                    *ngFor="let badge of block.badges"
                    (click)="onBadgeClick(badge)"
                    [style.background-color]="regionColors[badge] || '#6b7280'">
                {{badge}}
              </span>
            </div>
            <div class="badges" *ngIf="block.badges && block.id !== 'visual-map' && block.id !== 'calendar-map'">
              <span class="badge" *ngFor="let badge of block.badges">{{badge}}</span>
            </div>
          </div>
          <button class="remove-block-btn" (click)="removeBlock(block.id)" title="Remove block">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <!-- Block Content -->
        <div class="block-content" [class.collapsed]="block.isCollapsed">
          <!-- IA Summary -->
          <div *ngIf="block.content.type === 'summary'" class="summary-content">
            <p>{{block.content.text}}</p>
          </div>

          <!-- Current Exam -->
          <div *ngIf="block.content.type === 'current-exam'" class="current-exam-content">
            <h4 class="current-exam-title">CURRENT EXAM</h4>
            <div class="exam-details-list">
              <div class="exam-detail-item" *ngIf="exam">
                <span class="detail-key">Reference</span>
                <span class="detail-value">{{exam.reference}}</span>
              </div>
              <div class="exam-detail-item" *ngIf="exam">
                <span class="detail-key">Date</span>
                <span class="detail-value">{{exam.examDate | date:'dd/MM/yyyy HH:mm'}}</span>
              </div>
              <div class="exam-detail-item" *ngIf="exam">
                <span class="detail-key">Type</span>
                <span class="detail-value">{{exam.title}}</span>
              </div>
              <div class="exam-detail-item" *ngIf="exam">
                <span class="detail-key">Description</span>
                <span class="detail-value">{{exam.description}}</span>
              </div>
            </div>
          </div>

          <!-- Last Report Conclusion -->
          <div *ngIf="block.content.type === 'conclusion'" class="conclusion-content">
            <p>{{block.content.text}}</p>
          </div>

          <!-- Patient Records -->
          <div *ngIf="block.content.type === 'records'" class="records-content">
            <div class="record-item" *ngFor="let record of block.content.records">
              <div class="record-header">
                <span class="record-date">{{record.date}}</span>
                <span class="record-name">{{record.name}}</span>
              </div>
              <p class="record-description">{{record.description}}</p>
            </div>
            <div class="block-footer">
              <button class="see-all-btn">see all →</button>
            </div>
          </div>

          <!-- Visual Patient Map -->
          <div *ngIf="block.content.type === 'anatomical'" class="anatomical-content">
            <div class="anatomical-view">
              <img [src]="selectedAnatomicalView === 'bones' ? 'assets/skeleton+skin.svg' : 'assets/skeleton_and_organs.svg'" 
                   [alt]="selectedAnatomicalView === 'bones' ? 'Human Skeleton' : 'Human Organs'" 
                   class="human-body-svg"
                   (click)="onBodyClick($event)"
                   (wheel)="onSvgWheel($event)"
                   [style.transform]="'scale(' + svgZoomLevel + ')'"
                   [style.transformOrigin]="svgTransformOrigin">
            </div>
          </div>

          <!-- Calendar Map -->
          <div *ngIf="block.content.type === 'calendar-map'" class="calendar-map-content">
            <div class="calendar-map-layout">
              <!-- Left side: Human body SVG -->
              <div class="body-reference">
                <img src="assets/skeleton+skin.svg" 
                     alt="Human Skeleton Reference" 
                     class="reference-svg">
              </div>
              
              <!-- Right side: Timeline chart -->
              <div class="timeline-chart">
                <!-- Y-axis labels and lines -->
                <div class="y-axis">
                  <div class="y-axis-line" data-region="head">
                    <span class="y-label">Crâne</span>
                  </div>
                  <div class="region-space"
                       [class.selected]="isRegionSelected('Crâne')"
                       (mouseenter)="onRegionHover($event, 'head-shoulder')"
                       (mouseleave)="onRegionLeave($event)">
                  </div>
                  <div class="y-axis-line" data-region="thorax">
                    <span class="y-label">Thorax</span>
                  </div>
                  <div class="region-space"
                       [class.selected]="isRegionSelected('Thorax')"
                       (mouseenter)="onRegionHover($event, 'thorax-abdomen')"
                       (mouseleave)="onRegionLeave($event)">
                  </div>
                  <div class="y-axis-line" data-region="abdomen">
                    <span class="y-label">Abdomen</span>
                  </div>
                  <div class="region-space"
                       [class.selected]="isRegionSelected('Abdomen')"
                       (mouseenter)="onRegionHover($event, 'abdomen-pelvis')"
                       (mouseleave)="onRegionLeave($event)">
                  </div>
                  <div class="y-axis-line" data-region="pelvis">
                    <span class="y-label">Bassin</span>
                  </div>
                  <div class="region-space"
                       [class.selected]="isRegionSelected('Bassin') || isRegionSelected('Colonne vertébrale')"
                       (mouseenter)="onRegionHover($event, 'pelvis-leg')"
                       (mouseleave)="onRegionLeave($event)">
                  </div>
                  <div class="y-axis-line" data-region="membres">
                    <span class="y-label">Membres</span>
                  </div>
                  <div class="region-space"
                       [class.selected]="isRegionSelected('Membres')"
                       (mouseenter)="onRegionHover($event, 'leg-foot')"
                       (mouseleave)="onRegionLeave($event)">
                  </div>
                  <div class="y-axis-line" data-region="foot">
                    <span class="y-label">Pied</span>
                  </div>
                </div>
                
                <!-- Chart area with exam points -->
                <div class="chart-area">
                  <!-- X-axis (time) -->
                  <div class="x-axis">
                    <div class="x-axis-label" 
                         *ngFor="let month of getTimelineMonths()"
                         [style.left.%]="getMonthPosition(month)">
                      {{month.toLocaleDateString('fr-FR', {month: 'short', year: '2-digit'})}}
                    </div>
                  </div>
                  
                  <!-- Exam points -->
                  <div class="exam-points">
                    <div class="exam-point" 
                         *ngFor="let exam of getPatientExams()"
                         [style.background-color]="getPointColor(exam)"
                         [style.border-color]="getPointBorderColor(exam)"
                         [style.left.%]="getExamPosition(exam).x"
                         [style.top.%]="getExamPosition(exam).y"
                        (mouseenter)="onExamPointEnter($event, exam)"
                        (mouseleave)="onExamPointLeave()">
                    </div>
                  </div>
                  
                  <!-- Tooltip -->
                  <div class="exam-tooltip"
                       [hidden]="!hoveredExam"
                       [style.left.px]="tooltipPosition.x"
                       [style.top.px]="tooltipPosition.y"
                       (mouseenter)="onTooltipEnter()"
                       (mouseleave)="onTooltipLeave()"
                       (mousemove)="onTooltipMouseMove()">
                    <div class="tooltip-header">
                      <strong>{{hoveredExam?.title}}</strong>
                    </div>
                    <div class="tooltip-content">
                      <div class="tooltip-row">
                        <span class="tooltip-label">Date:</span>
                        <span class="tooltip-value">{{hoveredExam?.date.toLocaleDateString('fr-FR')}}</span>
                      </div>
                      <div class="tooltip-row">
                        <span class="tooltip-label">Région:</span>
                        <span class="tooltip-value">{{hoveredExam?.region}}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- All Images -->
          <div *ngIf="block.content.type === 'images'" class="images-content">
            <div class="date-group" *ngFor="let date of getImageDates()">
              <h5 class="date-header">{{formatDate(date)}}</h5>
              <div class="images-row">
                <div class="image-thumbnail" *ngFor="let image of block.content.imagesByDate[date]">
                  <img [src]="image" [alt]="'Medical image from ' + date" 
                       onerror="this.src='assets/images/radio/0-thumbnail.jpeg'">
                </div>
              </div>
            </div>
            <div class="block-footer">
              <button class="see-all-btn">see all →</button>
            </div>
          </div>

          <!-- Patient Information -->
          <div *ngIf="block.content.type === 'patient-info'" class="patient-info-content">
            <div class="info-section" *ngIf="exam">
              <h4>Patient Information</h4>
              <div class="info-item">
                <label>Name:</label>
                <span>{{exam.patientName}}</span>
              </div>
              <div class="info-item">
                <label>Date of Birth:</label>
                <span>{{exam.patientBirthDate | date:'dd/MM/yyyy'}}</span>
              </div>
              <div class="info-item">
                <label>Gender:</label>
                <span>{{exam.patientGender}}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>