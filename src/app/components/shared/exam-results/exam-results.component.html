<div [class]="getPageTypeClass()">

  <!-- Pagination Controls -->
  <div class="pagination-controls">
    <div class="items-per-page">
      <label>Items per page:</label>
      <select [value]="_currentItemsPerPage" (change)="onItemsPerPageChange($event)" class="items-select">
        <option *ngFor="let option of itemsPerPageOptions" [value]="option">{{option}}</option>
      </select>
    </div>
    
    <div class="pagination-nav">
      <button class="page-btn" (click)="goToFirstPage()" [disabled]="currentPageForDisplay === 1" title="First page">
        <i class="fas fa-angle-double-left"></i>
      </button>
      <button class="page-btn" (click)="previousPage()" [disabled]="currentPageForDisplay === 1" title="Previous page">
        <i class="fas fa-chevron-left"></i>
      </button>
      
      <div class="page-numbers">
        <button 
          *ngFor="let page of getPageNumbers()" 
          class="page-btn" 
          [class]="page === currentPageForDisplay ? 'page-btn active ' + getActiveBtnClass() : 'page-btn'"
          (click)="goToPage(page)">
          {{page}}
        </button>
      </div>
      
      <button class="page-btn" (click)="nextPage()" [disabled]="currentPageForDisplay === totalPagesForCurrentView" title="Next page">
        <i class="fas fa-chevron-right"></i>
      </button>
      <button class="page-btn" (click)="goToLastPage()" [disabled]="currentPageForDisplay === totalPagesForCurrentView" title="Last page">
        <i class="fas fa-angle-double-right"></i>
      </button>
    </div>
    
    <!-- View Mode Selector -->
    <div class="view-mode-selector">
      <div class="dropdown" [class.open]="isViewMenuOpen">
        <button class="view-menu-btn" (click)="toggleViewMenu()" title="View options">
          <i class="fas fa-bars"></i>
        </button>
        <div class="dropdown-menu">
          <button class="dropdown-item" [class.active]="viewMode === 'exam'" (click)="setViewMode('exam')">
            <i class="fas fa-x-ray"></i>
            <span>Examen view</span>
          </button>
          <button class="dropdown-item" [class.active]="viewMode === 'patient'" (click)="setViewMode('patient')">
            <i class="fas fa-user"></i>
            <span>Patient view</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Examen View - Card View (Default) -->
  <div class="exam-list card-view" *ngIf="displayMode === 'card' && viewMode === 'exam' && paginatedExams.length > 0">
    <div class="exam-card" [class]="getBorderClass()" [class.urgent-exam]="exam.isUrgent" *ngFor="let exam of paginatedExams" (click)="onOpenExam(exam)">
      <!-- Exam Header -->
      <div class="exam-header">
        <div class="exam-basic-info">
          <div class="exam-title">
            <h3 title="Exam title">{{exam.title}}</h3>
            <span class="exam-reference" title="Exam reference">{{exam.reference}}</span>
          </div>
          <div class="exam-meta">
            <span class="site-info" title="Site">
              <i class="fas fa-hospital"></i>
              {{exam.siteName}}
            </span>
            <span class="exam-date" title="Exam date">
              <i class="fas fa-calendar"></i>
              {{exam.examDate | date:'dd/MM/yyyy'}}
            </span>
            <span class="element-count" title="Number of elements">
              <i class="fas fa-images"></i>
              {{exam.elements.length}} elements
            </span>
          </div>
        </div>
        
        <div class="exam-status">
          <span class="diagnosis-badge" 
                [ngClass]="'diagnosis-' + exam.diagnosis" 
                title="Diagnosis">
            {{exam.diagnosis}}
          </span>
          <span class="urgent-badge" *ngIf="exam.isUrgent" title="Urgent exam">
            URGENT
          </span>
          <span class="unassigned-badge" *ngIf="showUnassignedBadge()" title="Unassigned exam">
            UNASSIGNED
          </span>
          <span class="completed-badge" *ngIf="showCompletedBadge()" title="Completed exam">
            COMPLETED
          </span>
        </div>
      </div>

      <!-- Patient Info -->
      <div class="patient-info">
        <div class="patient-details">
          <span class="patient-name" title="Patient name">
            <i class="fas fa-user"></i>
            {{exam.patientName}}
          </span>
          <span class="patient-age" title="Patient age">{{exam.patientAge}} years</span>
          <span class="patient-weight" title="Patient weight">{{exam.patientWeight}} kg</span>
        </div>
      </div>

      <!-- Assignment and Sharing -->
      <div class="assignment-section">
        <div class="assigned-user" title="Assigned radiologist">
          <i class="fas fa-user-md"></i>
          <span [class]="showUnassignedBadge() ? 'unassigned-text' : ''">
            {{showUnassignedBadge() ? 'Awaiting assignment' : (exam.assignedRadiologist || 'Unassigned')}}
          </span>
        </div>
        
        <div class="shared-users" *ngIf="exam.sharedUsers.length > 0">
          <span class="shared-label">Shared with:</span>
          <div class="shared-user" *ngFor="let user of exam.sharedUsers">
            <span class="user-name" title="Shared user">{{user.name}}</span>
            <span class="completion-percentage" title="Completion percentage">{{user.completion}}%</span>
            <i [class]="getStatusIcon(user.status)" 
               [style.color]="getStatusColor(user.status)"
               [title]="user.status"></i>
          </div>
        </div>
      </div>

      <!-- Conclusion Section (only for completed) -->
      <div class="conclusion-section" *ngIf="showConclusion()">
        <h4>Conclusion</h4>
        <p>{{exam.conclusion}}</p>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons" (click)="$event.stopPropagation()">
        <button [class]="getActionButtonClass()" (click)="onAddLabel(exam)" title="Add label">
          <i class="fas fa-tag"></i>
        </button>
        <button [class]="getActionButtonClass()" (click)="onPatientView(exam)" title="Patient View">
          <i class="fas fa-search"></i>
        </button>
        <button [class]="getActionButtonClass(true)" (click)="onAssignUser(exam)" title="Assign user">
          <i class="fas fa-user"></i>
        </button>
        <button [class]="getActionButtonClass()" (click)="onShareExam(exam)" title="Share exam">
          <i class="fas fa-users"></i>
        </button>
        <button [class]="getActionButtonClass()" (click)="onMoveToWorklist(exam)" title="Move to worklist">
          <i class="fas fa-paper-plane"></i>
        </button>
        <button [class]="getActionButtonClass()" (click)="onPauseExam(exam)" *ngIf="!showCompletedBadge()" title="Pause exam">
          <i class="fas fa-pause"></i>
        </button>
        <button [class]="getActionButtonClass(true)" *ngIf="showCompletedBadge()" title="View exam">
          <i class="fas fa-eye"></i>
        </button>
      </div>

      <!-- Image Display Toggle -->
      <div class="image-toggle" (click)="$event.stopPropagation()">
        <label class="toggle-switch">
          <input type="checkbox" [(ngModel)]="exam.showImagesInline">
          <span class="slider" [class]="'slider-' + pageType"></span>
          <span class="toggle-label">{{exam.showImagesInline ? 'Inline view' : 'Grid view'}}</span>
        </label>
      </div>

      <!-- Elements/Images -->
      <div class="exam-elements" [class.inline-view]="exam.showImagesInline">
        <div class="element-item" *ngFor="let element of exam.elements" [title]="element.name">
          <div class="element-thumbnail">
            <img [src]="element.thumbnail" [alt]="element.name" onerror="this.src='https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=100&h=100&fit=crop&auto=format&sat=-100'">
            <img [src]="element.thumbnail" [alt]="element.name" onerror="this.src='assets/images/radio/0-thumbnail.jpeg'">
            <div class="play-overlay" *ngIf="element.type === 'video'">
              <i class="fas fa-play"></i>
            </div>
          </div>
          <span class="element-name">{{element.name}}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Patient View - Card View -->
  <div class="patient-list card-view" *ngIf="displayMode === 'card' && viewMode === 'patient' && paginatedGroupedPatients.length > 0">
    <div class="patient-accordion" [class]="getBorderClass()" *ngFor="let patientGroup of paginatedGroupedPatients">
      <!-- Patient Header -->
      <div class="patient-header" (click)="togglePatientCard(patientGroup.patientName)">
        <div class="patient-basic-info">
          <h3 class="patient-name" title="Patient name">
            <i class="fas fa-user"></i>
            {{patientGroup.patientName}}
          </h3>
          <div class="patient-meta">
            <span class="patient-age" title="Patient age">{{patientGroup.patientInfo.patientAge}} years</span>
            <span class="patient-weight" title="Patient weight">{{patientGroup.patientInfo.patientWeight}} kg</span>
            <span class="exam-count" title="Number of exams">{{patientGroup.exams.length}} exam(s)</span>
          </div>
        </div>
        <div class="accordion-chevron">
          <i class="fas fa-chevron-down" [class.expanded]="patientGroup.isExpanded"></i>
        </div>
      </div>

      <!-- Exams List for this Patient -->
      <div class="patient-exams" [class.collapsed]="!patientGroup.isExpanded">
        <div class="exam-row-patient" [class.urgent-exam]="exam.isUrgent" *ngFor="let exam of patientGroup.exams" (click)="onOpenExam(exam)">
          <div class="exam-info-patient">
            <div class="exam-details-patient">
              <div class="exam-title-patient">{{exam.title}}</div>
              <div class="exam-meta-patient">
                <span class="sector-info">{{exam.sectorName}}</span>
                <span class="site-info">{{exam.siteName}}</span>
                <span class="exam-date">{{exam.examDate | date:'dd/MM/yyyy'}}</span>
                <span class="exam-reference">{{exam.reference}}</span>
              </div>
              
              <!-- Assignment Info -->
              <div class="assignment-info-patient">
                <div class="assigned-user-patient">
                  <i class="fas fa-user-md"></i>
                  <span [class]="showUnassignedBadge() ? 'unassigned-text' : ''">
                    {{showUnassignedBadge() ? 'Awaiting assignment' : (exam.assignedRadiologist || 'Unassigned')}}
                  </span>
                  <span class="completion-percentage" *ngIf="!showUnassignedBadge()">100%</span>
                  <i class="fas fa-check" style="color: #10b981" *ngIf="!showUnassignedBadge()"></i>
                </div>
                <button [class]="getActionButtonClass()" (click)="onPatientView(exam); $event.stopPropagation()" title="Patient History">
                  <i class="fas fa-search"></i>
                </button>
                
                <div class="shared-users-patient" *ngIf="exam.sharedUsers.length > 0">
                  <div class="shared-user-patient" *ngFor="let user of exam.sharedUsers">
                    <span class="user-name">{{user.name}}</span>
                    <span class="completion-percentage">{{user.completion}}%</span>
                    <i [class]="getStatusIcon(user.status)" 
                       [style.color]="getStatusColor(user.status)"></i>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="separator-vertical"></div>
            
            <div class="images-patient">
              <div class="element-thumbnail-patient" *ngFor="let element of exam.elements.slice(0, 10)">
                <img [src]="element.thumbnail" [alt]="element.name" 
                     onerror="this.src='assets/images/radio/0-thumbnail.jpeg'">
                <div class="play-overlay" *ngIf="element.type === 'video'">
                  <i class="fas fa-play"></i>
                </div>
              </div>
              <div class="more-images-patient" *ngIf="exam.elements.length > 10">
                +{{exam.elements.length - 10}}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Examen View - Row View -->
  <div class="exam-list row-view" *ngIf="displayMode === 'row' && viewMode === 'exam' && paginatedExams.length > 0">
    <div class="exam-row" [class]="getBorderClass()" [class.urgent-exam]="exam.isUrgent" *ngFor="let exam of paginatedExams" (click)="onOpenExam(exam)">
      <!-- Row Header -->
      <div class="row-header">
        <div class="exam-info-row">
          <span class="sector-info" title="Sector">{{exam.sectorName}}</span>
          <span class="site-info" title="Site">{{exam.siteName}}</span>
          <span class="exam-date" title="Exam date">{{exam.examDate | date:'dd/MM/yyyy'}}</span>
          <span class="exam-reference" title="Reference">{{exam.reference}}</span>
        </div>
        
        <div class="assignment-info">
          <div class="assigned-user-row">
            <i class="fas fa-user-md"></i>
            <span [class]="showUnassignedBadge() ? 'unassigned-text' : ''">
              {{showUnassignedBadge() ? 'Awaiting assignment' : (exam.assignedRadiologist || 'Unassigned')}}
            </span>
            <span class="completion-percentage" *ngIf="!showUnassignedBadge()">100%</span>
            <i class="fas fa-check" style="color: #10b981" *ngIf="!showUnassignedBadge()"></i>
          </div>
          
          <div class="shared-users-row" *ngIf="exam.sharedUsers.length > 0">
            <div class="shared-user-row" *ngFor="let user of exam.sharedUsers">
              <span class="user-name">{{user.name}}</span>
              <span class="completion-percentage">{{user.completion}}%</span>
              <i [class]="getStatusIcon(user.status)" 
                 [style.color]="getStatusColor(user.status)"></i>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Row Content -->
      <div class="row-content">
        <div class="patient-info-row">
          <span class="patient-name">{{exam.patientName}}</span>
          <span class="patient-gender">{{exam.patientAge}} years</span>
          <span class="patient-dob">{{exam.patientWeight}} kg</span>
        </div>
        
        <div class="separator-line"></div>
        
        <div class="images-row">
          <div class="element-thumbnail-row" *ngFor="let element of exam.elements.slice(0, 10)">
            <img [src]="element.thumbnail" [alt]="element.name" 
                 onerror="this.src='assets/images/radio/0-thumbnail.jpeg'">
            <div class="play-overlay" *ngIf="element.type === 'video'">
              <i class="fas fa-play"></i>
            </div>
          </div>
          <div class="more-images" *ngIf="exam.elements.length > 10">
            +{{exam.elements.length - 10}} more
          </div>
        </div>
      </div>
      
      <!-- Row Actions -->
      <div class="row-actions" (click)="$event.stopPropagation()">
        <button [class]="getActionButtonClass()" (click)="onAddLabel(exam)" title="Add label">
          <i class="fas fa-tag"></i>
        </button>
        <button [class]="getActionButtonClass()" (click)="onPatientView(exam)" title="Patient View">
          <i class="fas fa-search"></i>
        </button>
        <button [class]="getActionButtonClass(true)" (click)="onAssignUser(exam)" title="Assign user">
          <i class="fas fa-user"></i>
        </button>
        <button [class]="getActionButtonClass()" (click)="onShareExam(exam)" title="Share exam">
          <i class="fas fa-users"></i>
        </button>
        <button [class]="getActionButtonClass()" (click)="onMoveToWorklist(exam)" title="Move to worklist">
          <i class="fas fa-paper-plane"></i>
        </button>
        <button [class]="getActionButtonClass()" (click)="onPauseExam(exam)" *ngIf="!showCompletedBadge()" title="Pause exam">
          <i class="fas fa-pause"></i>
        </button>
        <button [class]="getActionButtonClass(true)" *ngIf="showCompletedBadge()" title="View exam">
          <i class="fas fa-eye"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Examen View - Table View -->
  <div class="exam-table-container" *ngIf="displayMode === 'table' && viewMode === 'exam' && paginatedExams.length > 0">
    <table class="exam-table">
      <thead>
        <tr>
          <th>Reference</th>
          <th>Patient</th>
          <th>Exam</th>
          <th>Site</th>
          <th>Sector</th>
          <th>Date</th>
          <th>Assigned</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr class="exam-table-row" [class]="getBorderClass()" [class.urgent-exam]="exam.isUrgent" *ngFor="let exam of paginatedExams">
          <td class="reference-cell">{{exam.reference}}</td>
          <td class="patient-cell">
            <div class="patient-info-table">
              <span class="patient-name">{{exam.patientName}}</span>
              <span class="patient-details">{{exam.patientAge}}y, {{exam.patientWeight}}kg</span>
            </div>
          </td>
          <td class="exam-cell">
            <div class="exam-info-table">
              <span class="exam-title">{{exam.title}}</span>
              <span class="exam-region">{{exam.anatomicalRegion}}</span>
            </div>
          </td>
          <td class="site-cell">{{exam.siteName}}</td>
          <td class="sector-cell">{{exam.sectorName}}</td>
          <td class="date-cell">{{exam.examDate | date:'dd/MM/yyyy'}}</td>
          <td class="assigned-cell">
            <span [class]="showUnassignedBadge() ? 'unassigned-text' : ''">
              {{showUnassignedBadge() ? 'Unassigned' : (exam.assignedRadiologist || 'Unassigned')}}
            </span>
          </td>
          <td class="status-cell">
            <span class="diagnosis-badge" [ngClass]="'diagnosis-' + exam.diagnosis">{{exam.diagnosis}}</span>
            <span class="urgent-badge" *ngIf="exam.isUrgent">URGENT</span>
          </td>
          <td class="actions-cell">
            <div class="table-actions" (click)="$event.stopPropagation()">
              <button [class]="getActionButtonClass(true)" title="Open exam">
                <i class="fas fa-external-link-alt"></i>
              </button>
              <button [class]="getActionButtonClass()" (click)="onPatientView(exam)" title="Patient View">
                <i class="fas fa-search"></i>
              </button>
              <button [class]="getActionButtonClass()" (click)="onAddLabel(exam)" title="Add label">
                <i class="fas fa-tag"></i>
              </button>
              <button [class]="getActionButtonClass(true)" (click)="onAssignUser(exam)" title="Assign user">
                <i class="fas fa-user"></i>
              </button>
              <button [class]="getActionButtonClass()" (click)="onShareExam(exam)" title="Share exam">
                <i class="fas fa-users"></i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- No Results -->
  <div class="no-results" *ngIf="exams.length === 0 || (viewMode === 'exam' && paginatedExams.length === 0) || (viewMode === 'patient' && paginatedGroupedPatients.length === 0)">
    <i [class]="noResultsIcon + ' no-results-icon-' + pageType"></i>
    <h3>{{noResultsTitle}}</h3>
  </div>
</div>